---
title: "Analisi Pinguini"
author: "Emanuel Michele Soda"
date: "11/27/2021"
output:
  html_document: 
    fig_width: 11
    fig_height: 10
    df_print: tibble
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 11 , fig.height =10)
library(tidyverse)
library(palmerpenguins)
library(tidymodels)
library(plotly)
library(factoextra)
library(sjPlot)
library(ggfortify)
theme_set(theme_light())
```

# Exploratory data aalysis
## Read data 
First of all we will read the data. The data contains some NA values. So, we 
will drop those NA values. After the drop ov the NA vallues the dimension of 
the tibble is $333$x$8$. 
```{r}
penguins_df <- penguins %>% drop_na() 
penguins_df %>%  dim()
```

## Number of penguin by species 
We have  three species of penguins:

* __Adelie__
* __Chinstrap__
* __Gentoo__
```{r}
penguins_df %>%  count(species)
```

## Number of penguin by sex 
As can be seen the number of male and female in the dataset is almost the same.
```{r}
penguins_df %>%  count(sex)
```

## Plot variance feature
```{r}
my_comparisons <- list(c("female", "male"))
penguins_df  %>% 
  select(-c(island, year)) %>%  
  pivot_longer(bill_length_mm:body_mass_g) %>% 
  mutate(name = factor(name)) %>% 
  
  ggplot(., aes(sex, value, fill = sex, color = species)) +
  geom_violin(width=0.7, color = "black", alpha = 0.8) +
  geom_jitter(width=0.2, aplha = 0.75, aes(size = value)) +
  geom_boxplot(width= 0.09, fill = "white", color = "black", alpha = 0.8) +
  scale_y_log10() +
  scale_fill_manual(values = c('#965F8A','#4AC6B7')) + 
  scale_color_manual(values = c('#965F8A','#4AC6B7', "#C61951")) +
  ggpubr::stat_compare_means(comparisons = my_comparisons, 
                             label = "p.signif") +
  facet_wrap("name", scales = "free") +
  scale_size(range = c(1, 3))


penguins_df  %>% 
  select(-c(island, year)) %>%  
  pivot_longer(bill_length_mm:body_mass_g) %>% 
  mutate(name = factor(name)) %>% 
  ggplot(., aes(value, fill = sex)) +
  geom_density(alpha= 0.8) +
  scale_fill_manual(values = c('#965F8A','#4AC6B7'))  +
  facet_wrap("name", scales = "free") +
  theme(legend.position="bottom") 
```

```{r}

ggstatsplot::ggcorrmat(
  data     = penguins_df  %>% select(-c(island, year, species, sex)),
  colors   = c("#B2182B", "white", "#4D4D4D"),
  title    = "Correlation among predictors",
  matrix.type  = "lower")

```


## Plot in a 3D space using the predictor
Let's make a scatterplot using three predictor which are:

* __bill_length_mm__
* __bill_depth_mm__
* __flipper_length_mm__

The size of the dot will be scaled by __body_mass_g__ and we will color the 
dot by sex
```{r}
plot_ly(penguins_df, x = ~bill_length_mm, y = ~bill_depth_mm, 
        z = ~flipper_length_mm, size = ~body_mass_g,
        marker = list(symbol = 'circle', 
                      sizemode = 'diameter'), 
        sizes = c(1, 20),
        color = ~sex, colors = c('#965F8A','#4AC6B7'))
```

Let's do the same for the __species__
```{r}
plot_ly(penguins_df, x = ~bill_length_mm, y = ~bill_depth_mm, 
        z = ~flipper_length_mm, size = ~body_mass_g,
        marker = list(symbol = 'circle', 
                      sizemode = 'diameter'), 
        sizes = c(1, 20),
        color = ~species, colors = c('#965F8A','#4AC6B7', "#C61951"))
penguins_df %>% 
  
ggplot(., aes(x = bill_length_mm, y = bill_depth_mm, 
              col = sex, shape = island, size = body_mass_g)) +
  geom_point(alpha = 0.7)  +
  scale_color_manual(values = c('#965F8A','#4AC6B7')) +
  theme(legend.position = "top") +
  facet_wrap("species")  
```

## PCA Plot

```{r}
pca_res <- prcomp(penguins_df %>% select(-c(species, island, year, sex)), 
                  scale. = TRUE) 
pca_res <- 
  pca_res$x %>% data.frame() %>% tibble() %>% 
  mutate(sex = penguins_df$sex, species = penguins_df$species) 
```

## PCA plot by sex
```{r}
plot_ly(pca_res, x = ~PC1, y = ~PC2, z = ~PC3,
        color = ~sex, colors = c('#965F8A','#4AC6B7'))
```

## PCA plot by species
```{r}
plot_ly(pca_res, x = ~PC1, y = ~PC2, z = ~PC3,
        color = ~species, colors = c('#965F8A','#4AC6B7', "#C61951"))
```

# Creation of the model to predict the sex
As we have seen from the plot the data cluster very well according to the three 
species, this because of course the three species are based on  those measurements.
For this reason we will try to predict the sex based on those measurements. 

First of all we have to create the training dataset that we will call
__penguin_train__. Unfortunately the entire dataset  has only 333 sample. Those
are not a lot for those reason order to improve the performance we will use 
the resampling.

The dimension of the training is 249 and for the test we have 84.
```{r}
penguins_df <- penguins_df %>% select(- c(year, island, species))
# Creation of a split stratified by sex in order to have the same number of observation in each group 
penguin_split <- initial_split(penguins_df, strata = sex)

penguin_train <- training(penguin_split)
penguin_test <- testing(penguin_split)
```

# Creating the model 
We will use two very simple model __logistic regression__ and
__random forest__
```{r}
glm_spec <- logistic_reg() %>%
  set_engine("glm")

rf_spec <- rand_forest() %>%
  set_mode("classification") %>%
  set_engine("ranger")

# In order to fit the model we need to  create a workflow so

penguin_wf <- workflow() %>%
  add_formula(sex ~ .)
```

# Fit the model

## Creting the resampling dataset
```{r}
folds <- vfold_cv(data = penguin_train, v = 10,repeats = 5, strata = sex)
folds
```

## Fitting the model
```{r}
# Logistic model
pengun_logistic <-
  penguin_wf %>% 
  add_model(glm_spec) %>%
  fit_resamples(
    resamples = folds,
    control = control_resamples(save_pred = T))

# Random Forest model 
pengun_random_forest <-
  penguin_wf %>% 
  add_model(rf_spec) %>%
  fit_resamples(
    resamples = folds,
    control = control_resamples(save_pred = T))
```

# Metrics 
## Accuracy and AUC 
As can be seen even if the __Random Forest_ is more complex  model as can 
be seen the __Logistic Regression__ have similar performance. 
For this reason we will use the __Logistic Regression__ because is a lot simpler
to interpret.

```{r}
collect_metrics(pengun_logistic)

collect_metrics(pengun_random_forest)
```

# ROC curve
As can be see the ROC Curve for each resample is quite good 
```{r}
pengun_logistic %>%
  collect_predictions() %>%
  group_by(id) %>%
  roc_curve(sex, .pred_female) %>%
  ggplot(aes(1 - specificity, sensitivity, color = id)) +
  geom_abline(lty = 2, color = "gray60") +
  geom_path() +
  theme(legend.position = "bottom") +
  scale_color_brewer(palette = "Set3") +
  coord_equal()
```

## Confusion Matrix

And also the Confusion matrix is quite good
```{r}
penguin_final <- penguin_wf %>%
  add_model(glm_spec) %>%
  last_fit(penguin_split)

collect_metrics(penguin_final)


collect_predictions(penguin_final) %>%
  conf_mat(sex, .pred_class)
```


# Interpretation 
The use of a  __logistic regression__ is good because is a very simple  and so
very interpretable model. In particular there is a property for which the 
if the exponentiate parameter of the model corresponds to the odds ration 
```{r}
penguin_final$.workflow[[1]] %>%
  tidy(exponentiate = TRUE)  %>% 
  mutate(p.value = round(p.value, 10)) %>% 
 mutate(estimate = round(estimate, 5))
```

For this reason  we can say that for each $1$ mm increment in the 
__bill_depth_mm__the odds of beeing male vs beeing female increase of $6.16$ 
time.
```{r}
m1 <- stats::glm(formula = sex ~., family =  stats::binomial, penguin_train)

plot_model(m1, sort.est = TRUE)


```


Last we plot the model parameter for the predictor
```{r}
ggstatsplot::ggcoefstats(m1, ggtheme = theme_light())
```

















